<template v-if="currentSession === 'home'">
    <div class="arrow-buttons mt-4">
        <div v-for="(color, lead) in colorsForLeads" :key="lead" class="arrow-button"
        :class="{ selected: lead === selectedLead }" :style="{ backgroundColor: color, '--arrow-color': color }"
        @click="selectLead(lead)">
        <span>{{ lead }}</span>
        <span style="font-weight: bold;margin-left:6px;color:black;font-size:1.2rem;">({{ stageWiseCount[lead] }})</span>
    </div>
    </div>
    <v-data-table :headers="headers" :items="dataTable" :search="search" :sort-by="[]" style="font-size: 14px;"
        :loading="appIsLoading" fixed-header items-per-page="20" style="height:93vh;">
        <template v-slot:top>
            <v-toolbar :elevation="6">
                <v-text-field v-model="search" prepend-inner-icon="mdi-magnify" density="compact" label="Search"
                    single-line flat hide-details variant="solo-filled"></v-text-field>
                <v-spacer></v-spacer>
                <v-dialog v-model="dialog" max-width="900px">
                    <template v-slot:activator="{ props }">
                        <v-btn color="blue" dark class="mb-2 mx-2" v-bind="props" prepend-icon="mdi-plus"
                            variant="elevated" v-if="showAddNewBtn">
                            New Lead
                        </v-btn>
                    </template>
                    <v-card>
                        <v-card-title>
                            <span class="text-h5">{{ formTitle }}</span>
                        </v-card-title>
                        <v-card-text>
                            <v-container>
                                <v-row>
                                    <v-col v-for="fld in schema" :key="fld.key" cols="12" sm="6" md="4">
                                        <div v-if="fld.type === 'text'">
                                            <v-text-field variant="outlined" v-model="editedItem[fld.key]"
                                                :label="fld.label" :rules="fld.required ? [rules.required]:[]"
                                                :disabled="fld.disabled||false"></v-text-field>
                                        </div>
                                        <div v-if="fld.type === 'formula'">
                                            <v-text-field variant="outlined" v-model="editedItem[fld.key]"
                                                :label="fld.label" :rules="fld.required ? [rules.required]:[]"
                                                :disabled="true"></v-text-field>
                                        </div>
                                        <div v-if="fld.type === 'textarea'">
                                            <v-textarea variant="outlined" v-model="editedItem[fld.key]"
                                                :label="fld.label" :rules="fld.required ? [rules.required]:[]"
                                                :disabled="fld.disabled||false"></v-textarea>
                                        </div>
                                        <div v-if="fld.type === 'select' || fld.type === 'select_inline_editable'">
                                            <v-select variant="outlined" v-model="editedItem[fld.key]"
                                                :label="fld.label" :items="fld.options.split(',')"
                                                :rules="fld.required ? [rules.required]:[]"
                                                :disabled="fld.disabled||false"></v-select>
                                        </div>
                                        <div v-if="fld.type === 'select_option_source'">
                                            <v-select v-model="editedItem[fld.key]" :label="fld.label"
                                                :items="fld.options" :item-title="fld.optionSource.label"
                                                :item-value="fld.optionSource.key"
                                                :rules="fld.required ? [rules.required]:[]"
                                                :update:modelValue="handleSelectChange(editedItem,fld)"
                                                variant="outlined" :disabled="fld.disabled||false"></v-select>
                                        </div>
                                        <div v-if="fld.type === 'checkbox'">
                                            <v-checkbox v-model="editedItem[fld.key]" :label="fld.label"
                                                :rules="fld.required ? [rules.required]:[]"></v-checkbox>
                                        </div>
                                        <div v-if="fld.type === 'tags'">
                                            <v-combobox v-model="editedItem[fld.key]" :label="fld.label"
                                                :items="fld.options.split(',')"
                                                :rules="fld.required ? [rules.required]:[]"
                                                :disabled="fld.disabled||false" chips multiple></v-combobox>
                                        </div>
                                        <div v-if="fld.type === 'radio'">
                                            <v-radio-group inline v-model="editedItem[fld.key]"
                                                :rules="fld.required ? [rules.required]:[]">
                                                <template v-slot:label>
                                                    <div>{{fld.label}}</div>
                                                </template>
                                                <v-radio v-for="opt in fld.options.split(',')" :key="opt" :label="opt"
                                                    :value="opt"></v-radio>
                                            </v-radio-group>
                                        </div>
                                        <div v-if="fld.type === 'date'">
                                            <v-text-field variant="outlined" v-model="editedItem[fld.key]"
                                                :label="fld.label" type="date"
                                                :rules="fld.required ? [rules.required]:[]"
                                                :disabled="fld.disabled||false"></v-text-field>
                                        </div>
                                        <div v-if="fld.type === 'time'">
                                            <label for="appt-time">{{fld.label}} </label>
                                            <input v-model="editedItem[fld.key]" id="appt-time" type="time"
                                                name="appt-time" value="13:30" :disabled="fld.disabled"
                                                :rules="fld.required ? [rules.required]:[]" />

                                        </div>
                                        <div v-if="fld.type === 'link'">
                                            <v-text-field variant="outlined" v-model="editedItem[fld.key]"
                                                :label="fld.label" type="text"
                                                :rules="fld.required ? [rules.required]:[]"></v-text-field>
                                        </div>
                                        <div v-if="fld.type === 'number' ||fld.type === 'number_currency'">
                                            <v-text-field variant="outlined" v-model="editedItem[fld.key]"
                                                :label="fld.label" type="number" :min="fld.min" :max="fld.max"
                                                :rules="fld.required ? [rules.required]:[]"
                                                :disabled="fld.disabled||false" @change="()=>{
                      calculate(editedItem,editedItem[fld.key])
                    }"></v-text-field>
                                        </div>

                                    </v-col>

                                </v-row>
                            </v-container>
                        </v-card-text>

                        <v-card-actions>
                            <v-spacer></v-spacer>
                            <v-btn color="blue-darken-1" variant="text" @click="close">
                                Cancel
                            </v-btn>
                            <v-btn color="blue-darken-1" variant="text" @click="save">
                                Save
                            </v-btn>
                        </v-card-actions>
                    </v-card>
                </v-dialog>
                <v-dialog v-model="dialogDelete" max-width="500px">
                    <v-card>
                        <v-card-title class="text-h5">Are you sure you want to delete this
                            record?</v-card-title>
                        <v-card-actions>
                            <v-spacer></v-spacer>
                            <v-btn color="blue-darken-1" variant="text" @click="closeDelete">Cancel</v-btn>
                            <v-btn color="blue-darken-1" variant="text" @click="deleteItemConfirm">OK</v-btn>
                            <v-spacer></v-spacer>
                        </v-card-actions>
                    </v-card>
                </v-dialog>
                <v-dialog v-model="viewDialog" max-width="900">
                    <v-card>
                        <v-card-title class="text-h5">Detail</v-card-title>
                        <table
                            style="width: 98%; border-collapse: collapse; margin: 10px;padding:20px; background-color: #f9f9f9;">

                            <tr style="border-bottom: 1px solid #ddd;" v-for="fld in schema" :key="fld.key">
                                <td style="padding: 10px; border: 1px solid #ddd; text-align: left;width:30%;">
                                    {{fld.label}}
                                </td>
                                <td style="padding: 10px; border: 1px solid #ddd; text-align: left; width:70%;">
                                    <template v-if="fld.type === 'date'">
                                        {{new Date(editedItem[fld.key]).toLocaleDateString(prefs.Locale) }}
                                    </template>
                                    <template v-else-if="fld.type === 'time'">
                                        {{editedItem[fld.key]}}
                                    </template>
                                    <template v-else-if="fld.type === 'link'">
                                        <a :href="editedItem[fld.key]" target="_blank">Open</a>
                                    </template>
                                    <template v-else-if="fld.type === 'file'">
                                        <a :href="editedItem[fld.key]" target="_blank">Open</a>
                                    </template>
                                    <template v-else-if="fld.type === 'image'">
                                        <a :href="editedItem[fld.key]" target="_blank"> <v-avatar
                                                :image="editedItem[fld.key]" size="64"></v-avatar></a>
                                    </template>
                                    <template v-else-if="fld.type === 'number_currency'">
                                        {{editedItem[fld.key]?.toLocaleString(prefs.Locale, {
                                        style: 'currency',
                                        currency: prefs.Currency,
                                        })}}
                                    </template>
                                    <template v-else>
                                        {{editedItem[fld.key]}}
                                    </template>
                                </td>
                            </tr>
                            <tr style="border-bottom: 1px solid #ddd;" v-if="editedItem['history']">
                                <td style="padding: 10px; border: 1px solid #ddd; text-align: left;width:30%;">
                                    Edit History
                                </td>
                                <td style="padding: 10px; border: 1px solid #ddd; text-align: left;width:70%;">
                                    <v-timeline side="end">
                                        <v-timeline-item class="mb-4" dot-color="green" size="small"
                                            v-for="(o,i) in JSON.parse(editedItem['history'])" :key="i">{{o}}
                                        </v-timeline-item>
                                    </v-timeline>
                                </td>
                            </tr>
                        </table>
                    </v-card>

                </v-dialog>
            </v-toolbar>
        </template>
        <template v-slot:item.actions="{ item }">
            <div style="width:100px;">
                <v-icon size="small" class="me-2" @click="editItem(item)" color="green" v-if="showEditBtn">
                    mdi-pencil
                </v-icon>
                <v-icon size="small" class="me-2" @click="viewItem(item)" color="blue">
                    mdi-eye
                </v-icon>
                <v-icon size="small" @click="deleteItem(item)" color="red" v-if="showDeleteBtn">
                    mdi-delete
                </v-icon>
            </div>
        </template>
        <template v-slot:item.rating="{ item }">
            <v-rating :model-value="item.rating" color="blue-darken-2" density="compact" size="small"
                readonly></v-rating>
        </template>
        <template v-for="header in headers.filter((header) => header.type==='number_currency')"
            v-slot:[`item.${header.key}`]="{ header, value }">
            {{value?.toLocaleString(prefs.Locale, {
            style: 'currency',
            currency: prefs.Currency,
            })}}
        </template>
        <template v-for="header in headers.filter((header) => header.type==='select_inline_editable')"
            v-slot:[`item.${header.key}`]="{ value ,item}">
            <div class="pa-4 text-center">
                <v-dialog width="auto" scrollable>
                    <template v-slot:activator="{ props: activatorProps }">
                        <v-btn :color="colorsForLeads[value]" :text="value" variant="flat" v-bind="activatorProps"
                            @click="()=>{
                                editedItem[header.key] = value;
                                this.editedIndex = this.dataTable.indexOf(item);
                this.editedItem = Object.assign({}, item);
                            }"></v-btn>
                    </template>

                    <template v-slot:default="{ isActive }">
                        <v-card :title="`Change ${header.title}`">
                            <v-divider class="mt-3"></v-divider>
                            <v-card-text class="px-4" style="height: 80px;">
                                <v-select v-if="editedItem"
                                    :items="schema.find(fld=>fld.key===header.key).options.split(',')"
                                    label="Select Stage" variant="outlined" v-model="editedItem[header.key]"></v-select>
                            </v-card-text>

                            <v-divider></v-divider>
                            <v-card-actions>
                                <v-btn text="Close" @click="isActive.value = false"></v-btn>
                                <v-spacer></v-spacer>
                                <v-btn color="surface-variant" text="Save" variant="flat" @click="()=>{
                                        save();
                                        isActive.value = false;
                                    }"></v-btn>
                            </v-card-actions>
                        </v-card>
                    </template>
                </v-dialog>
            </div>
        </template>
        <template v-for="header in headers.filter((header) => header.type==='date')"
            v-slot:[`item.${header.key}`]="{ header, value }">
            {{ value !==''? new Date(value).toLocaleDateString() : value }}
        </template>
        <template v-for="header in headers.filter((header) => header.type==='link')"
            v-slot:[`item.${header.key}`]="{ header, value }">
            <div class="text-center">

                <a :href="value" target="_blank">Open</a>
            </div>
        </template>
        <template v-slot:item.stock="{ item }">
            <div class="text-end">
                <v-chip :color="item.stock ? 'green' : 'red'" :text="item.stock ? 'In stock' : 'Out of stock'"
                    class="text-uppercase" label size="small"></v-chip>
            </div>
        </template>
        <template v-slot:item.approval="{ item }">
            <div class="text-center">
                <v-chip :color="item.approval == 'Yes' ? 'green' : 'red'" :text="item.approval == 'Yes' ? 'Yes' : 'No'"
                    :prepend-icon="item.approval == 'Yes' ? 'mdi-checkbox-marked-circle' : 'mdi-close'" class="ma-2"
                    size="small">
                    {{item.approval}}</v-chip>
            </div>
        </template>
        <template v-slot:item.assigned_to="{ item,value }">
            <div class="text-center">
                {{this.users?this.users[value]['name']:value}}
            </div>
        </template>
        <template v-for="header in headers.filter((header) => header.key==='status')"
            v-slot:[`item.${header.key}`]="{ header, value }">
            <div class="text-center" v-if="value">
                <v-chip :color="value === 'Approved' ? 'teal' : value === 'Hold' ? 'orange' : 'red'"
                    :prepend-icon="value === 'Approved' ? 'mdi-checkbox-marked-circle' : value === 'Hold' ? 'mdi-progress-alert' : 'mdi-alert'"
                    size="small">
                    {{value}}
                </v-chip>
            </div>
        </template>
        <template v-for="header in headers.filter((header) => header.key==='🔔 Priority')"
            v-slot:[`item.${header.key}`]="{ header, value }">
            <div class="text-center">
                <v-chip :color="value === 'High' ? 'red' : value === 'Medium' ? 'orange' : 'green'" :text="value"
                    class="text-uppercase" label size="small"></v-chip>
            </div>
        </template>
        <template v-for="header in headers.filter((header) => header.key==='🏷️ Tags')"
            v-slot:[`item.${header.key}`]="{ header, value }">
            <div class="text-center">
                <v-chip-group>
                    <v-chip v-for="tag in value.split(',')" :key="tag" color="lime" label size="small">
                        {{tag}}
                    </v-chip>
                </v-chip-group>
            </div>
        </template>
        <template v-slot:no-data>
            <v-btn color="primary" @click="initialize">
                Reset
            </v-btn>
        </template>
    </v-data-table>
</template>
