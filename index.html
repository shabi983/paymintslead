<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/@mdi/font@4.x/css/materialdesignicons.min.css" rel="stylesheet" />
  <script src="https://unpkg.com/vue@3"></script>
  <script src="https://cdn.jsdelivr.net/npm/vuetify@3.0.5"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/vuetify/3.4.8/vuetify-labs.min.js"
    integrity="sha512-5xeIAXqNP/DWGkolQzdPAL042aA4Lb8SCMy/Ju+9yzvf9SzfsbzICQwYyMrhbN8pG8m0LWhMl9BISpIDs8RquQ=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/vuetify/3.4.8/vuetify-labs.min.css"
    integrity="sha512-VP/8WyNQxaDeiVsCGXh7nLWVPt64+rqoCugT7xhZLhx9F8fTJpjpiCqHqJlhmKAMgyRU8TiAAxJmmxz260R03w=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <!-- import css.html -->
    <style>
    .arrow-buttons {
        display: flex;
        height: 60px;
    }

    .arrow-button {
        flex: 1;
        border: none;
        color: rgb(255, 255, 255);
        font-size: 18px;
        font-weight: bold;
        position: relative;
        cursor: pointer;
        padding: 0 15px;
        transition: transform 0.1s, box-shadow 0.1s;
        /* Center the text */
        display: flex;
        align-items: center;
        /* Vertically centers the text */
        justify-content: center;
        /* Horizontally centers the text */
        text-align: center;
        /* Ensures text is centered */
        height: 100%;
        /* Full height of the button */
    }

    .arrow-button::after {
        content: '';
        position: absolute;
        right: -30px;
        top: 0;
        border-top: 30px solid transparent;
        border-bottom: 30px solid transparent;
        border-left: 30px solid var(--arrow-color);
        z-index: 1;
    }

    .arrow-button:last-child::after {
        display: none;
    }

    .selected {
        transform: scale(1.05);
        /* Scale the button by 5% */
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        /* Apply shadow */
        z-index: 2;
        /* Ensure the selected button appears above other elements */
    }
</style>
</head>



<body>
  <div id="app"></div>
  <script type="text/x-template" id="app-template">
    async function fetchData() {
      const url = "https://script.google.com/macros/s/AKfycbxy3OIHbjL317GNxG6GiuQRysPVA74sHCtiAnsHfCpq_FLpEFI6dGS1JqGlZ80sXYR_/exec"; // Replace with your actual deployment URL

      try {
        const response = await fetch(url);
        if (!response.ok) throw new Error("Network response was not ok");

        const data = await response.json(); // Assuming JSON data is returned
        document.getElementById("output").innerText = `Message: ${data.message}, Timestamp: ${data.timestamp}`;
      } catch (error) {
        console.error("Error fetching data:", error);
      }
    }
  </script>


  <template v-if="currentSession === 'changePasswordSession'">
    <v-card width="600" class="mx-auto my-2 px-4 py-4">
        <h4 class="mx-4">Change password</h4>
        <v-form :loading="submitting">
            <v-text-field v-model="changePasswordForm.oldPassword" label="Old Password" required></v-text-field>
            <v-text-field v-model="changePasswordForm.newPassword" label="New Password" required></v-text-field>
            <v-text-field v-model="changePasswordForm.confirmPassword" label="Confirm Password" required></v-text-field>
            <v-btn @click="changePassword">Change Password</v-btn>
        </v-form>
    </v-card>
</template>

  <template v-if="currentSession === 'invitation'">
    <v-card width="600" class="mx-auto my-2 px-4 py-4">
        <h4 class="mx-4"><b>Send invitation</b></h4>
        <v-form :loading="submitting">
            <v-text-field v-model="invitationForm.email" label="Email" required></v-text-field>
            <v-select v-model="invitationForm.role" :items="['admin', 'standard']" label="Role" required></v-select>
            <v-btn @click="sendInvitation">Send</v-btn>
        </v-form>
    </v-card>
</template>
  
  <template v-if="currentSession === 'login'">
    <v-card width="600" class="mx-auto my-2 px-4 py-4">
        <h4 class="mx-4"><b>Log in</b></h4>
        <v-form :loading="submitting">
            <v-text-field v-model="loginForm.email" label="Email" required></v-text-field>
            <v-text-field v-model="loginForm.password" label="Password" required></v-text-field>
            <v-btn @click="login" color="blue">Log in</v-btn>
        </v-form>
    </v-card>
</template>

  <template v-if="currentSession==='manageUsers'">
    <div>
        <v-data-table-virtual :headers="userHeaders" :items="Object.values(users)" height="400">
            <template v-slot:item.role="{ item }">
                <v-chip :color="item.role === 'admin' || item.role === 'owner' ? 'teal' : 'grey'">
                    {{ item.role }}
                </v-chip>
            </template>
            <template v-slot:item.status="{ item }">
                <v-chip :color="item.status === 'active' ? 'teal' : 'grey'">
                    {{ item.status }}
                </v-chip>
            </template>
            <template v-slot:item.action="{ item }">
                <v-btn prepend-icon="mdi-swap-horizontal"
                    v-if="item.role !== 'owner' && item.email !== currentUser.email" @click="changeUserRole(item)">
                    <template v-slot:prepend>
                        <v-icon color="green"></v-icon>
                    </template>
                    Change Role
                </v-btn>
                <v-btn prepend-icon="mdi-delete" v-if="item.role !== 'owner' && item.email !== currentUser.email"
                    @click="deleteUser(item)">
                    <template v-slot:prepend>
                        <v-icon color="red"></v-icon>
                    </template>
                    Delete
                </v-btn>

            </template>
        </v-data-table-virtual>
        <v-dialog v-model="dialogDeleteUser" max-width="600px">
            <v-card>
                <v-card-title class="text-h5">Are you sure you want to delete this
                    User?</v-card-title>
                <v-card-actions>
                    <v-spacer></v-spacer>
                    <v-btn color="blue-darken-1" variant="text" @click="()=>{
                        dialogDeleteUser = false;
                    }">Cancel</v-btn>
                    <v-btn color="blue-darken-1" variant="text" @click="deleteUserConfirm">OK</v-btn>
                    <v-spacer></v-spacer>
                </v-card-actions>
            </v-card>
        </v-dialog>

        <v-dialog v-model="dialogChangeUserRole" max-width="600px">
            <v-card>
                <v-card-title class="text-h5">Change Role</v-card-title>
                <v-card-text>
                    <v-select v-model="popupData.role" :items="['admin', 'standard']" label="Role"></v-select>
                </v-card-text>
                <v-card-actions>

                    <v-btn color="blue-darken-1" variant="text" @click="()=>{
                        dialogChangeUserRole = false;
                    }">Cancel</v-btn>
                    <v-spacer></v-spacer>
                    <v-btn color="blue-darken-1" variant="text" @click="changeUserRoleConfirm">OK</v-btn>

                </v-card-actions>
            </v-card>
        </v-dialog>
    </div>

</template>






<template v-if="currentSession==='manageInvitations'">
    <v-data-table :items="Object.values(invitations)" :headers="invitationHeaders">
        <template v-slot:item.role="{ item }">
            <v-chip :color="item.role === 'admin' || item.role === 'owner' ? 'teal' : 'grey'">
                {{ item.role }}
            </v-chip>
        </template>
        <template v-slot:item.status="{ item }">
            <v-chip :color="item.status === 'active' ? 'teal' : 'grey'">
                {{ item.status }}
            </v-chip>
        </template>
        <template v-slot:item.action="{ item }">
            <v-btn prepend-icon="mdi-delete" v-if="item.role !== 'owner' && item.email !== currentUser.email"
                @click="deleteInvitation(item)">
                <template v-slot:prepend>
                    <v-icon color="red"></v-icon>
                </template>
                Delete
            </v-btn>

        </template>
    </v-data-table>
    <v-dialog v-model="dialogDeleteInvitation" max-width="600px">
        <v-card>
            <v-card-title class="text-h5">Are you sure you want to delete this
                Invitation?</v-card-title>
            <v-card-actions>
                <v-spacer></v-spacer>
                <v-btn color="blue-darken-1" variant="text" @click="()=>{
                    dialogDeleteInvitation = false;
                }">Cancel</v-btn>
                <v-btn color="blue-darken-1" variant="text" @click="deleteInvitationConfirm">OK</v-btn>
                <v-spacer></v-spacer>
            </v-card-actions>
        </v-card>
    </v-dialog>
</template>

  <template v-if="currentSession === 'signup'">
  <v-card width="600" class="mx-auto my-2 px-4 py-4">
    <h4 class="mx-4">Sign up</h4>
    <v-form :loading="submitting">
      <v-text-field v-model="signupForm.email" label="Email" required @change="()=>{
                checkInvitation()
              }"></v-text-field>
      <v-text-field v-model="signupForm.invitation" label="Invitation code" required @change="()=>{
                checkInvitation()
              }"></v-text-field>
      <v-text-field v-model="signupForm.role" label="Role" disabled></v-text-field>
      <v-text-field v-model="signupForm.name" label="Name" required></v-text-field>
      <v-text-field v-model="signupForm.password" label="Password" required></v-text-field>
      <v-text-field v-model="signupForm.passwordConfirmed" label="Confirm password" required></v-text-field>

      <v-btn @click="signup">Sign up</v-btn>
    </v-form>
  </v-card>
</template>

  <template v-if="currentSession === 'home'">
    <div class="arrow-buttons mt-4">
        <div v-for="(color, lead) in colorsForLeads" :key="lead" class="arrow-button"
        :class="{ selected: lead === selectedLead }" :style="{ backgroundColor: color, '--arrow-color': color }"
        @click="selectLead(lead)">
        <span>{{ lead }}</span>
        <span style="font-weight: bold;margin-left:6px;color:black;font-size:1.2rem;">({{ stageWiseCount[lead] }})</span>
    </div>
    </div>
    <v-data-table :headers="headers" :items="dataTable" :search="search" :sort-by="[]" style="font-size: 14px;"
        :loading="appIsLoading" fixed-header items-per-page="20" style="height:93vh;">
        <template v-slot:top>
            <v-toolbar :elevation="6">
                <v-text-field v-model="search" prepend-inner-icon="mdi-magnify" density="compact" label="Search"
                    single-line flat hide-details variant="solo-filled"></v-text-field>
                <v-spacer></v-spacer>
                <v-dialog v-model="dialog" max-width="900px">
                    <template v-slot:activator="{ props }">
                        <v-btn color="blue" dark class="mb-2 mx-2" v-bind="props" prepend-icon="mdi-plus"
                            variant="elevated" v-if="showAddNewBtn">
                            New Lead
                        </v-btn>
                    </template>
                    <v-card>
                        <v-card-title>
                            <span class="text-h5">{{ formTitle }}</span>
                        </v-card-title>
                        <v-card-text>
                            <v-container>
                                <v-row>
                                    <v-col v-for="fld in schema" :key="fld.key" cols="12" sm="6" md="4">
                                        <div v-if="fld.type === 'text'">
                                            <v-text-field variant="outlined" v-model="editedItem[fld.key]"
                                                :label="fld.label" :rules="fld.required ? [rules.required]:[]"
                                                :disabled="fld.disabled||false"></v-text-field>
                                        </div>
                                        <div v-if="fld.type === 'formula'">
                                            <v-text-field variant="outlined" v-model="editedItem[fld.key]"
                                                :label="fld.label" :rules="fld.required ? [rules.required]:[]"
                                                :disabled="true"></v-text-field>
                                        </div>
                                        <div v-if="fld.type === 'textarea'">
                                            <v-textarea variant="outlined" v-model="editedItem[fld.key]"
                                                :label="fld.label" :rules="fld.required ? [rules.required]:[]"
                                                :disabled="fld.disabled||false"></v-textarea>
                                        </div>
                                        <div v-if="fld.type === 'select' || fld.type === 'select_inline_editable'">
                                            <v-select variant="outlined" v-model="editedItem[fld.key]"
                                                :label="fld.label" :items="fld.options.split(',')"
                                                :rules="fld.required ? [rules.required]:[]"
                                                :disabled="fld.disabled||false"></v-select>
                                        </div>
                                        <div v-if="fld.type === 'select_option_source'">
                                            <v-select v-model="editedItem[fld.key]" :label="fld.label"
                                                :items="fld.options" :item-title="fld.optionSource.label"
                                                :item-value="fld.optionSource.key"
                                                :rules="fld.required ? [rules.required]:[]"
                                                :update:modelValue="handleSelectChange(editedItem,fld)"
                                                variant="outlined" :disabled="fld.disabled||false"></v-select>
                                        </div>
                                        <div v-if="fld.type === 'checkbox'">
                                            <v-checkbox v-model="editedItem[fld.key]" :label="fld.label"
                                                :rules="fld.required ? [rules.required]:[]"></v-checkbox>
                                        </div>
                                        <div v-if="fld.type === 'tags'">
                                            <v-combobox v-model="editedItem[fld.key]" :label="fld.label"
                                                :items="fld.options.split(',')"
                                                :rules="fld.required ? [rules.required]:[]"
                                                :disabled="fld.disabled||false" chips multiple></v-combobox>
                                        </div>
                                        <div v-if="fld.type === 'radio'">
                                            <v-radio-group inline v-model="editedItem[fld.key]"
                                                :rules="fld.required ? [rules.required]:[]">
                                                <template v-slot:label>
                                                    <div>{{fld.label}}</div>
                                                </template>
                                                <v-radio v-for="opt in fld.options.split(',')" :key="opt" :label="opt"
                                                    :value="opt"></v-radio>
                                            </v-radio-group>
                                        </div>
                                        <div v-if="fld.type === 'date'">
                                            <v-text-field variant="outlined" v-model="editedItem[fld.key]"
                                                :label="fld.label" type="date"
                                                :rules="fld.required ? [rules.required]:[]"
                                                :disabled="fld.disabled||false"></v-text-field>
                                        </div>
                                        <div v-if="fld.type === 'time'">
                                            <label for="appt-time">{{fld.label}} </label>
                                            <input v-model="editedItem[fld.key]" id="appt-time" type="time"
                                                name="appt-time" value="13:30" :disabled="fld.disabled"
                                                :rules="fld.required ? [rules.required]:[]" />

                                        </div>
                                        <div v-if="fld.type === 'link'">
                                            <v-text-field variant="outlined" v-model="editedItem[fld.key]"
                                                :label="fld.label" type="text"
                                                :rules="fld.required ? [rules.required]:[]"></v-text-field>
                                        </div>
                                        <div v-if="fld.type === 'number' ||fld.type === 'number_currency'">
                                            <v-text-field variant="outlined" v-model="editedItem[fld.key]"
                                                :label="fld.label" type="number" :min="fld.min" :max="fld.max"
                                                :rules="fld.required ? [rules.required]:[]"
                                                :disabled="fld.disabled||false" @change="()=>{
                      calculate(editedItem,editedItem[fld.key])
                    }"></v-text-field>
                                        </div>

                                    </v-col>

                                </v-row>
                            </v-container>
                        </v-card-text>

                        <v-card-actions>
                            <v-spacer></v-spacer>
                            <v-btn color="blue-darken-1" variant="text" @click="close">
                                Cancel
                            </v-btn>
                            <v-btn color="blue-darken-1" variant="text" @click="save">
                                Save
                            </v-btn>
                        </v-card-actions>
                    </v-card>
                </v-dialog>
                <v-dialog v-model="dialogDelete" max-width="500px">
                    <v-card>
                        <v-card-title class="text-h5">Are you sure you want to delete this
                            record?</v-card-title>
                        <v-card-actions>
                            <v-spacer></v-spacer>
                            <v-btn color="blue-darken-1" variant="text" @click="closeDelete">Cancel</v-btn>
                            <v-btn color="blue-darken-1" variant="text" @click="deleteItemConfirm">OK</v-btn>
                            <v-spacer></v-spacer>
                        </v-card-actions>
                    </v-card>
                </v-dialog>
                <v-dialog v-model="viewDialog" max-width="900">
                    <v-card>
                        <v-card-title class="text-h5">Detail</v-card-title>
                        <table
                            style="width: 98%; border-collapse: collapse; margin: 10px;padding:20px; background-color: #f9f9f9;">

                            <tr style="border-bottom: 1px solid #ddd;" v-for="fld in schema" :key="fld.key">
                                <td style="padding: 10px; border: 1px solid #ddd; text-align: left;width:30%;">
                                    {{fld.label}}
                                </td>
                                <td style="padding: 10px; border: 1px solid #ddd; text-align: left; width:70%;">
                                    <template v-if="fld.type === 'date'">
                                        {{new Date(editedItem[fld.key]).toLocaleDateString(prefs.Locale) }}
                                    </template>
                                    <template v-else-if="fld.type === 'time'">
                                        {{editedItem[fld.key]}}
                                    </template>
                                    <template v-else-if="fld.type === 'link'">
                                        <a :href="editedItem[fld.key]" target="_blank">Open</a>
                                    </template>
                                    <template v-else-if="fld.type === 'file'">
                                        <a :href="editedItem[fld.key]" target="_blank">Open</a>
                                    </template>
                                    <template v-else-if="fld.type === 'image'">
                                        <a :href="editedItem[fld.key]" target="_blank"> <v-avatar
                                                :image="editedItem[fld.key]" size="64"></v-avatar></a>
                                    </template>
                                    <template v-else-if="fld.type === 'number_currency'">
                                        {{editedItem[fld.key]?.toLocaleString(prefs.Locale, {
                                        style: 'currency',
                                        currency: prefs.Currency,
                                        })}}
                                    </template>
                                    <template v-else>
                                        {{editedItem[fld.key]}}
                                    </template>
                                </td>
                            </tr>
                            <tr style="border-bottom: 1px solid #ddd;" v-if="editedItem['history']">
                                <td style="padding: 10px; border: 1px solid #ddd; text-align: left;width:30%;">
                                    Edit History
                                </td>
                                <td style="padding: 10px; border: 1px solid #ddd; text-align: left;width:70%;">
                                    <v-timeline side="end">
                                        <v-timeline-item class="mb-4" dot-color="green" size="small"
                                            v-for="(o,i) in JSON.parse(editedItem['history'])" :key="i">{{o}}
                                        </v-timeline-item>
                                    </v-timeline>
                                </td>
                            </tr>
                        </table>
                    </v-card>

                </v-dialog>
            </v-toolbar>
        </template>
        <template v-slot:item.actions="{ item }">
            <div style="width:100px;">
                <v-icon size="small" class="me-2" @click="editItem(item)" color="green" v-if="showEditBtn">
                    mdi-pencil
                </v-icon>
                <v-icon size="small" class="me-2" @click="viewItem(item)" color="blue">
                    mdi-eye
                </v-icon>
                <v-icon size="small" @click="deleteItem(item)" color="red" v-if="showDeleteBtn">
                    mdi-delete
                </v-icon>
            </div>
        </template>
        <template v-slot:item.rating="{ item }">
            <v-rating :model-value="item.rating" color="blue-darken-2" density="compact" size="small"
                readonly></v-rating>
        </template>
        <template v-for="header in headers.filter((header) => header.type==='number_currency')"
            v-slot:[`item.${header.key}`]="{ header, value }">
            {{value?.toLocaleString(prefs.Locale, {
            style: 'currency',
            currency: prefs.Currency,
            })}}
        </template>
        <template v-for="header in headers.filter((header) => header.type==='select_inline_editable')"
            v-slot:[`item.${header.key}`]="{ value ,item}">
            <div class="pa-4 text-center">
                <v-dialog width="auto" scrollable>
                    <template v-slot:activator="{ props: activatorProps }">
                        <v-btn :color="colorsForLeads[value]" :text="value" variant="flat" v-bind="activatorProps"
                            @click="()=>{
                                editedItem[header.key] = value;
                                this.editedIndex = this.dataTable.indexOf(item);
                this.editedItem = Object.assign({}, item);
                            }"></v-btn>
                    </template>

                    <template v-slot:default="{ isActive }">
                        <v-card :title="`Change ${header.title}`">
                            <v-divider class="mt-3"></v-divider>
                            <v-card-text class="px-4" style="height: 80px;">
                                <v-select v-if="editedItem"
                                    :items="schema.find(fld=>fld.key===header.key).options.split(',')"
                                    label="Select Stage" variant="outlined" v-model="editedItem[header.key]"></v-select>
                            </v-card-text>

                            <v-divider></v-divider>
                            <v-card-actions>
                                <v-btn text="Close" @click="isActive.value = false"></v-btn>
                                <v-spacer></v-spacer>
                                <v-btn color="surface-variant" text="Save" variant="flat" @click="()=>{
                                        save();
                                        isActive.value = false;
                                    }"></v-btn>
                            </v-card-actions>
                        </v-card>
                    </template>
                </v-dialog>
            </div>
        </template>
        <template v-for="header in headers.filter((header) => header.type==='date')"
            v-slot:[`item.${header.key}`]="{ header, value }">
            {{ value !==''? new Date(value).toLocaleDateString() : value }}
        </template>
        <template v-for="header in headers.filter((header) => header.type==='link')"
            v-slot:[`item.${header.key}`]="{ header, value }">
            <div class="text-center">

                <a :href="value" target="_blank">Open</a>
            </div>
        </template>
        <template v-slot:item.stock="{ item }">
            <div class="text-end">
                <v-chip :color="item.stock ? 'green' : 'red'" :text="item.stock ? 'In stock' : 'Out of stock'"
                    class="text-uppercase" label size="small"></v-chip>
            </div>
        </template>
        <template v-slot:item.approval="{ item }">
            <div class="text-center">
                <v-chip :color="item.approval == 'Yes' ? 'green' : 'red'" :text="item.approval == 'Yes' ? 'Yes' : 'No'"
                    :prepend-icon="item.approval == 'Yes' ? 'mdi-checkbox-marked-circle' : 'mdi-close'" class="ma-2"
                    size="small">
                    {{item.approval}}</v-chip>
            </div>
        </template>
        <template v-slot:item.assigned_to="{ item,value }">
            <div class="text-center">
                {{this.users?this.users[value]['name']:value}}
            </div>
        </template>
        <template v-for="header in headers.filter((header) => header.key==='status')"
            v-slot:[`item.${header.key}`]="{ header, value }">
            <div class="text-center" v-if="value">
                <v-chip :color="value === 'Approved' ? 'teal' : value === 'Hold' ? 'orange' : 'red'"
                    :prepend-icon="value === 'Approved' ? 'mdi-checkbox-marked-circle' : value === 'Hold' ? 'mdi-progress-alert' : 'mdi-alert'"
                    size="small">
                    {{value}}
                </v-chip>
            </div>
        </template>
        <template v-for="header in headers.filter((header) => header.key==='🔔 Priority')"
            v-slot:[`item.${header.key}`]="{ header, value }">
            <div class="text-center">
                <v-chip :color="value === 'High' ? 'red' : value === 'Medium' ? 'orange' : 'green'" :text="value"
                    class="text-uppercase" label size="small"></v-chip>
            </div>
        </template>
        <template v-for="header in headers.filter((header) => header.key==='🏷️ Tags')"
            v-slot:[`item.${header.key}`]="{ header, value }">
            <div class="text-center">
                <v-chip-group>
                    <v-chip v-for="tag in value.split(',')" :key="tag" color="lime" label size="small">
                        {{tag}}
                    </v-chip>
                </v-chip-group>
            </div>
        </template>
        <template v-slot:no-data>
            <v-btn color="primary" @click="initialize">
                Reset
            </v-btn>
        </template>
    </v-data-table>
</template>

  <template v-if="currentSession === 'userInfo'">
    <v-card width="600" class="mx-auto my-2 px-4 py-4">
        <h4 class="mx-4"><b>{{currentUser.name}}</b></h4>
        <v-text-field v-model="currentUser.email" label="Email" disabled></v-text-field>
        <v-text-field v-model="currentUser.role" label="Role" disabled></v-text-field>
        <v-form :loading="submitting">
            <v-text-field v-model="currentUser.name" label="Name" required></v-text-field>

            <v-btn @click="changeUserProfile">Save</v-btn> <v-btn @click="goToSession('changePasswordSession')"
                :disabled="submitting">Change Password</v-btn>


        </v-form>
    </v-card>
</template>


  <script>
    const approvalMixin = {
        data() {
            return {
                disabledFieldsForStandardUsers: ['name', 'created_date'],
                disabledFieldsForAdminUsers: [],
                showEditBtn: true,
                showDeleteBtn: true,
                showAddNewBtn: true,
            }
        },
        methods: {
            computeStageWiseTotalCount() {
                // Initialize or reset the stage-wise count
                let stageCounts = {
                    "Lead": 0,
                    "Contacted": 0,
                    "Pitched": 0,
                    "Sent Demo": 0,
                    "Negotiating": 0,
                    "Closed-Won": 0,
                    "Closed-Lost": 0
                };

                // Iterate over the filtered data to compute counts
                this.dataTable.forEach(item => {
                    if (item.stage in stageCounts) {
                        stageCounts[item.stage]++;
                    }
                });
                stageCounts['All']=this.dataTable.length;

                // Update the data property with the computed counts
                this.stageWiseCount = stageCounts;
            },
            filterDataOnRoleBasis: function () {
                if (!this.currentUser || !this.schema) {
                    return;
                }
                let { role, email, name } = this.currentUser;
                switch (role) {
                    case 'standard':
                        this.dataTable = this.dataTable.filter(item => item['assigned_to'] === email)
                        this.schema.forEach((item) => {
                            if (item.key === 'assigned_to' && item.options.length) {
                                item.options = item.options.filter(o => o.Email === this.currentUser.email)
                            }
                        }
                        );

                        this.disabledFieldsForStandardUsers.forEach((item) => {
                            this.schema.forEach((item) => {
                                if (item.key === item) {
                                    item.disabled = true
                                }
                            }
                            );
                        });
                        break;
                    case 'admin':
                        // remove user having role as owner from the options of assigned_to field
                        this.schema.forEach((item) => {
                            if (item.key === 'assigned_to' && item.options.length) {
                                item.options = item.options.filter(o => o.Role !== 'owner')
                            }
                        }
                        );
                        break;
                    default:
                        break;
                }
                this.computeStageWiseTotalCount();
            },
        }
    }
</script>
  

  <script>
    const authMixin = {
        data() {
            return {
                loginForm: {
                    email: "",
                    password: "",
                },
                signupForm: {
                    invitation: "",
                    role: "",
                    name: "",
                    email: "",
                    password: "",
                    passwordConfirmed: "",
                },
                invitationForm: {
                    email: "",
                    invitation: "",
                },
                approvalForm: {
                    uuid: '',
                    titile: '',
                    description: '',
                    assignTo: '',
                    createdBy: '',
                    files: '',
                    status: '',
                    comments: '',
                },
                changePasswordForm: {
                    oldPassword: '',
                    newPassword: '',
                    confirmPassword: '',
                },
                files: null,
                currentUser: null,
                currentSession: 'login',
                users: {},
                invitations: {},
                userHeaders: [
                    { title: 'Name', align: 'start', key: 'name' },

                    { title: 'Email', align: 'start', key: 'email' },
                    { title: 'Role', align: 'start', key: 'role' },
                    { title: 'Status', align: 'start', key: 'status' },
                    { title: 'Actions', align: 'start', key: 'action' },
                ],
                invitationHeaders: [
                    { title: 'Email', align: 'start', key: 'email' },
                    { title: 'Invitation', align: 'start', key: 'invitation' },
                    { title: 'Role', align: 'start', key: 'role' },
                    { title: 'Status', align: 'start', key: 'status' },
                    { title: 'Actions', align: 'start', key: 'action' },
                ],
                approvals: {},
                submitting: false,
                message: "",
                popupData: {},
                dialogDeleteInvitation: false,
                dialogDeleteUser: false,
                dialogChangeUserRole: false,
                drawer: false,
                group: null,

            }
        },
        watch: {
            currentUser: function (newVal, oldVal) {
                if (newVal) {
                    console.log("User is logged in", newVal);
                    this.filterDataOnRoleBasis()
                }
            },
            group() {
                this.drawer = false
            },
        },
        mounted() {
            this.getUserData();
        },
        methods: {
            getUserData: function () {
                let userData = JSON.parse(localStorage.getItem("data"))
                if (userData) {
                    this.showSnackbar("Attempting to log in...", "teal", -1);
                    let { email, token } = userData
                    google.script.run
                        .withSuccessHandler(userToken => {
                            if (userToken === token) {
                                google.script.run
                                    .withSuccessHandler(({ users, approvals, invitations }) => {
                                        this.users = users
                                        this.approvals = approvals
                                        this.invitations = invitations
                                        this.currentUser = JSON.parse(JSON.stringify(users[email]))
                                        this.currentSession = "home"
                                        this.showSnackbar("Welcome back, " + this.currentUser.name + "!", "green");

                                    })
                                    .getData()

                            } else {
                                google.script.run
                                    .withSuccessHandler(invitations => {
                                        this.invitations = invitations
                                        this.showSnackbar("Please log in again.", "orange");
                                    })
                                    .getInvitations()
                            }

                        })
                        .getToken(email)
                } else {
                    google.script.run
                        .withSuccessHandler(invitations => {
                            this.invitations = invitations
                        })
                        .getInvitations()
                }
            },
            login: function () {
                this.showSnackbar("Log in...", "teal");
                let email = this.loginForm.email.trim().toLowerCase()
                let password = this.loginForm.password.trim()
                console.log(email);
                if (email && password) {
                    this.submitting = true
                    google.script.run
                        .withSuccessHandler(({ token, users, approvals, invitations }) => {
                            switch (token) {
                                case "invalid":

                                    this.showSnackbar("Email address not found.", "red");
                                    break
                                case "mismatch":

                                    this.showSnackbar("Wrong password.", "red");
                                    break
                                default:
                                    this.users = users
                                    this.approvals = approvals
                                    this.invitations = invitations
                                    this.currentUser = JSON.parse(JSON.stringify(this.users[email]))
                                    localStorage.setItem("data", JSON.stringify({ email, token }))

                                    this.showSnackbar("Welcome, " + this.currentUser.name + "!", "teal");
                                    this.filterDataOnRoleBasis();
                                    this.goToSession("home")
                                    break
                            }

                            this.submitting = false
                        })
                        .withFailureHandler(this.showError)
                        .login(email, password)
                } else {

                    this.showSnackbar("Email and password can't be empty.", "red");
                }
            },
            signup: function () {
                this.message = ``
                let email = this.signupForm.email.trim().toLowerCase();
                console.log(email);
                if (this.signupForm.role) {
                    if (this.invitations[email].status !== "new") {

                        this.showSnackbar("Invalid inviataion status: " + this.invitations[email].status + ", please ask admin for help.", "red");
                    } else {
                        if (this.signupForm.password !== this.signupForm.passwordConfirmed) {

                            this.showSnackbar("Passwords don't match", "red");
                        } else {
                            // save sign up info to the database
                            this.submitting = true

                            this.showSnackbar("Submitting...", "teal");
                            google.script.run
                                .withSuccessHandler(user => {
                                    this.users[email] = user

                                    this.showSnackbar("Thanks for you registration, please login.", "teal");
                                    this.resetSignupForm()
                                    this.submitting = false

                                })
                                .withFailureHandler(this.showError)
                                .addUser(this.signupForm)
                        }
                    }
                } else {

                    this.showSnackbar("Role can't be empty, please check if the email and invitation code are correct.", "red");
                }
            },
            sendInvitation: function () {
                let email = this.invitationForm.email.trim().toLowerCase()
                let role = this.invitationForm.role

                this.showSnackbar("Sending...", "teal");
                if (role && email) {
                    if (this.invitations[email]) {

                        this.showSnackbar("User " + email + " was already invited, please try another email or sign up.", "red");
                    } else {
                        this.submitting = true
                        google.script.run
                            .withSuccessHandler(invitation => {
                                this.invitations[invitation.email] = invitation
                                this.submitting = false

                                this.showSnackbar("An invitation has been send to " + email + ".", "teal");
                                this.resetInvitationForm()
                            })
                            .withFailureHandler(this.showError)
                            .sendInvitation(email, role)
                    }
                } else {

                    this.showSnackbar("Email and role can't be empty.", "red");
                }
            },
            checkInvitation: function () {
                this.signupForm.role = ""
                let invitation = this.signupForm.invitation.trim()
                let email = this.signupForm.email.trim().toLowerCase()
                console.log("Invitations", this.invitations);
                if (email && invitation) {
                    if (this.invitations[email]) {
                        let invitedUser = this.invitations[email]
                        if (invitedUser.invitation === invitation) {
                            this.signupForm.role = invitedUser.role
                        }
                    }
                }
            },
            createApproval: function () {
                if (this.approvalForm.assignTo.indexOf("@")) {
                    if (this.approvalForm.assignTo && this.approvalForm.title) {
                        this.submitting = true
                        this.message = `<p class="teal-text">Sending ...<\/p>`
                        let email = this.currentUser.email.toString()
                        this.approvalForm.createdBy = email
                        this.approvalForm.files = this.files

                        google.script.run
                            .withSuccessHandler(approval => {
                                this.approvals[approval.uuid] = approval
                                this.approvals = JSON.parse(JSON.stringify(this.approvals))

                                this.resetApprovalForm()
                                this.message = `<p class="teal-text">New approval has been created.<\/p>`
                                this.submitting = false
                            })
                            .withFailureHandler(this.showError)
                            .createApproval(this.approvalForm)
                    } else {
                        this.message = `<p class="red-text">Assgin to and title can't be empty.<\/p>`
                    }
                } else {
                    this.message = `<p class="red-text">Assgin to has to be a valid email address.<\/p>`
                }
            },
            changeApprovalStatus: function () {
                this.message = `<p class="teal-text">Sending ...<\/p>`
                this.popupData.callback = null
                let email = this.popupData.email
                let uuid = this.popupData.uuid
                let status = this.popupData.status
                let comments = this.popupData.comments
                comments = `[${this.currentUser.email}]-[${status}]-[${comments}]`
                if (email === undefined) {
                    google.script.run
                        .withSuccessHandler(approval => {
                            this.approvals[approval.uuid] = approval
                            this.approvals = JSON.parse(JSON.stringify(this.approvals))
                            this.message = `<p class="teal-text">${approval.status}<br>${approval.comments}<\/p>`
                            this.submitting = false
                            this.popupData = {}
                        })
                        .withFailureHandler(this.showError)
                        .changeApprovalStatus(email, uuid, status, comments)
                } else {
                    if (this.popupData.email.indexOf("@") > 0) {
                        google.script.run
                            .withSuccessHandler(approval => {
                                this.approvals[approval.uuid] = approval
                                this.approvals = JSON.parse(JSON.stringify(this.approvals))
                                this.message = `<p class="teal-text">${approval.status}<br>${approval.comments}<\/p>`
                                this.submitting = false
                                this.popupData = {}
                            })
                            .withFailureHandler(this.showError)
                            .changeApprovalStatus(email, uuid, status, comments)
                    } else {
                        this.message = `<p class="red-text">Reassign to email address is invalid.<\/p>`
                    }
                }
            },
            logout: function () {
                this.currentUser = null
                this.goToSession("login")
                this.refresh();
                localStorage.removeItem('data')
            },
            goToSession: function (session) {
                switch (session) {
                    case "login":
                        this.resetLoginForm()
                        break
                    case "signup":
                        this.resetSignupForm()
                        break
                    case "invitation":
                        this.resetInvitationForm()
                        break
                    case "newApproval":
                        this.resetApprovalForm()
                        break
                    case "userInfo":
                        let email = this.currentUser.email
                        this.currentUser = JSON.parse(JSON.stringify(this.users[email]))
                        break
                    case "allApprovals":
                        break
                    case "pendingApprovals":
                        break
                    case "sentApprovals":
                        break
                    case "manageUsers":
                        break
                    case "changePasswordSession":
                        this.resetChangePasswordForm()
                        break
                }
                this.currentSession = session;
                this.drawer = false;
            },
            resetLoginForm: function () {
                this.loginForm = {
                    email: "",
                    password: "",
                }
            },
            resetSignupForm: function () {
                this.signupForm = {
                    invitation: "",
                    role: "",
                    name: "",

                    email: "",
                    password: "",
                    passwordConfirmed: "",
                }
            },
            resetInvitationForm: function () {
                this.invitationForm = {
                    email: "",
                    invitation: "",
                }
                // M.FormSelect.init(document.querySelectorAll('select'))
            },
            resetApprovalForm: function () {
                this.approvalForm = {
                    uuid: '',
                    titile: '',
                    description: '',
                    assignTo: '',
                    createdBy: '',
                    files: '',
                    status: '',
                    comments: '',
                }
                this.files = []
                let fileinput = document.querySelector("#files-new-approval")
                if (fileinput) {
                    fileinput.value = null
                }

            },
            resetChangePasswordForm: function () {
                this.changePasswordForm = {
                    oldPassword: '',
                    newPassword: '',
                    confirmPassword: '',
                }
            },
            showError: function (error) {
                this.message = `<p class="red-text">${error.message}<\/p>`
                this.submitting = false
            },
            readFiles: function (e) {
                let files = e.target.files
                this.files = []
                for (let i = 0; i < files.length; i++) {
                    let file = files[i]
                    this.files.push({
                        name: file.name,
                        type: file.type,
                        data: null
                    })

                    let reader = new FileReader()
                    reader.onload = () => {
                        this.files[i].data = reader.result.split(";base64,")[1]
                    }
                    reader.readAsDataURL(file)
                }

            },
            setPopup: function (data) {
                this.popupData = data
            },

            deleteUser: function (data) {
                this.popupData = data
                this.dialogDeleteUser = true;
            },
            deleteInvitation: function (data) {
                this.popupData = data
                this.dialogDeleteInvitation = true;
            },
            changeUserRole: function (data) {
                this.popupData.email = data.email
                this.dialogChangeUserRole = true;
            },

            changeUserRoleConfirm: function () {
                let email = this.popupData.email
                let role = this.popupData.role
                if (email && role) {
                    if (role !== this.users[email].role) {
                        this.submitting = true

                        this.showSnackbar("Submitting...", "teal");
                        google.script.run
                            .withSuccessHandler(() => {

                                this.showSnackbar("Role has been change to " + role, "teal");
                                this.users[email].role = role
                                this.users = JSON.parse(JSON.stringify(this.users))
                                this.submitting = false

                            })
                            .withFailureHandler(this.showError)
                            .changeUserRole(email, role)
                    } else {

                        this.showSnackbar("No role change to the user.", "red");
                    }
                }
            },
            changeUserProfile: function () {
                if (this.currentUser.name) {
                    this.submitting = true

                    this.showSnackbar("Submitting...", "teal");
                    google.script.run
                        .withSuccessHandler(() => {

                            this.users[this.currentUser.email] = this.currentUser
                            this.users = JSON.parse(JSON.stringify(this.users))
                            this.submitting = false
                        })
                        .withFailureHandler(this.showError)
                        .changeUserProfile(this.currentUser)
                } else {

                    this.showSnackbar("User profile can't be empty.", "red");
                }

            },
            deleteUserConfirm: function () {
                let key = this.popupData.email
                if (key) {
                    this.submitting = true
                    this.message = `<p class="teal-text">Deleting user ${this.popupData.name} ...<\/p>`
                    this.showSnackbar("Submitting...", "teal");
                    google.script.run
                        .withSuccessHandler(() => {
                            delete (this.users[key])
                            this.users = JSON.parse(JSON.stringify(this.users))

                            this.showSnackbar("User has been removed.", "teal");
                            this.submitting = false
                        })
                        .withFailureHandler(this.showError)
                        .deleteUser(key)
                }
            },
            deleteInvitationConfirm: function () {
                let key = this.popupData.email
                this.submitting = true
                this.showSnackbar("Submitting...", "teal");
                if (key) {
                    google.script.run
                        .withSuccessHandler(() => {
                            delete (this.invitations[key])
                            this.invitations = JSON.parse(JSON.stringify(this.invitations))
                            this.showSnackbar("User has been removed.", "teal");
                            this.submitting = false
                        })
                        .withFailureHandler(this.showError)
                        .deleteInvitation(key)
                }

            },
            cancelApproval: function () {
                let key = this.popupData.uuid
                this.submitting = true
                this.message = `<p class="teal-text">Cancelling approval ${this.popupData.approvalTitle} ...<\/p>`
                if (key) {
                    google.script.run
                        .withSuccessHandler(() => {
                            delete (this.approvals[key])
                            this.approvals = JSON.parse(JSON.stringify(this.approvals))
                            this.message = `<p class="teal-text">User ${this.popupData.approvalTitle} has been removed.<\/p>`
                            this.submitting = false
                        })
                        .withFailureHandler(this.showError)
                        .cancelApproval(key)
                }
            },
            changePassword: function () {
                let oldPassword = this.changePasswordForm.oldPassword
                let newPassword = this.changePasswordForm.newPassword
                let confirmPassword = this.changePasswordForm.confirmPassword


                this.showSnackbar("Submitting...", "teal");
                if (oldPassword && newPassword && confirmPassword) {
                    if (newPassword !== confirmPassword) {

                        this.showSnackbar("New password and confirmed password are mismatch.", "red");
                    } else {
                        if (newPassword === oldPassword) {

                            this.showSnackbar("New password can't be the same with old one.", "red");
                        } else {
                            // save the change to spreadsheet
                            this.submitting = true
                            google.script.run
                                .withSuccessHandler(result => {
                                    if (result) {

                                        this.showSnackbar(result, "teal");
                                        this.logout()
                                    } else {

                                        this.showSnackbar("The old password is wrong.", "red");
                                    }
                                    this.submitting = false
                                })
                                .withFailureHandler(this.showError)
                                .changePassword(this.currentUser.email, oldPassword, newPassword)
                        }
                    }
                } else {

                    this.showSnackbar("Passwords can't be empty.", "red");
                }

            },
        }
    }
</script>  


  <script>
    const computeMixin = {
        methods: {
            calculate(editedItem, fld) {
                if (fld.key === 'Rate' || fld.key === 'Quantity') {
                        editedItem['Amount'] = editedItem['Quantity'] * editedItem['Rate'];
                    }
            },
            handleSelectChange(editedItem, fld) {
                console.log(editedItem, fld)
                if (this.appName == 'Sales') {
                    console.log("key", fld.key);
                    const selectedItem = fld.options.find(option => option[fld.optionSource.key] === editedItem['Product']);
                    editedItem['Rate'] = selectedItem ? selectedItem['Rate'] : 0;
                    editedItem['Image'] = selectedItem ? selectedItem['Item Image'] : '';
                    // Do the calculation again if required
                    this.calculate(editedItem, fld);
                }
            }
        }
    }
</script>

  
  <script>
    const leadManagmentMixin = {
        data() {
            return {
                colorsForLeads: {
                    "All": "#7c959c",
                    "Lead": "#2ce6ff",
                    "Contacted": "#09c8c6",
                    "Pitched": "#098ec8",
                    "Sent Demo": "#cb00ff",
                    "Negotiating": "#ffa700",
                    "Closed-Won": "#09c849",
                    "Closed-Lost": "#ff338e"
                },
                selectedLead: null,
                stageWiseCount: {}
            }
        },
        watch: {
            selectedLead(newStage, oldStage) {
                // filter the data based on the selected lead
                if (newStage) {
                    this.filterDataByLeadStatus(newStage);
                } else {
                    this.dataTable = this.unfilteredDataTable;
                }
            }
        },
        methods: {
            selectLead(lead) {
                this.selectedLead = lead;
            },
            filterDataByLeadStatus(stage) {
                let { role, email, name } = this.currentUser;

                if (role === 'owner') {
                    if (stage === "All") {
                        this.dataTable = this.unfilteredDataTable;
                    } else {
                        const filtered = this.unfilteredDataTable.filter((item) => item.stage === stage);
                        this.dataTable = filtered;
                    }

                    return;
                }

                if (stage === "All") {
                    this.dataTable = this.unfilteredDataTable.filter(item => item['assigned_to'] === email);
                } else {
                    const filtered = this.unfilteredDataTable.filter((item) => item.stage === stage && item['assigned_to'] === email);
                    this.dataTable = filtered;
                }

            },
        }
    }
</script>

  <v-app>
    <v-card>
        <v-layout>
            <v-app-bar color="#39c13e" prominent>
                <v-app-bar-nav-icon variant="text" @click.stop="drawer = !drawer"></v-app-bar-nav-icon>
                <v-btn prepend-icon="mdi-home" @click="goToSession('home')" v-if="currentUser">
                    <template v-slot:prepend>
                        <v-icon color="white"></v-icon>
                    </template>
                </v-btn>
                <v-toolbar-title>{{prefs?.AppName}}</v-toolbar-title>
                <v-spacer></v-spacer>
                <template v-if="$vuetify.display.mdAndUp">
                    <v-btn prepend-icon="mdi-account-circle" color="white" @click="goToSession('signup')"
                        v-if="!currentUser">
                        <template v-slot:prepend>
                            <v-icon color="success"></v-icon>
                        </template>
                        Sign-up
                    </v-btn>
                    <v-btn prepend-icon="mdi-account-circle" color="white" @click="goToSession('login')"
                        v-if="!currentUser">
                        <template v-slot:prepend>
                            <v-icon color="success"></v-icon>
                        </template>
                        Login
                    </v-btn>
                    <v-btn prepend-icon="mdi-logout" color="white" variant="elevated" @click="logout"
                        v-if="currentUser">
                        <template v-slot:prepend>
                            <v-icon color="red"></v-icon>
                        </template>
                        Logout
                    </v-btn>
                </template>
                <v-btn icon="mdi-dots-vertical" variant="text"></v-btn>
            </v-app-bar>
            <v-navigation-drawer v-model="drawer" :location="$vuetify.display.mobile ? 'bottom' : undefined" temporary>
                <v-list color="transparent" v-if="currentUser">
                    <v-list-item prepend-icon="mdi-home" title="Home" @click="goToSession('home')"></v-list-item>
                    <v-list-item prepend-icon="mdi-send-circle" title="Send Invitation"
                        @click="goToSession('invitation')" v-if="currentUser.role=='owner'"></v-list-item>
                    <v-list-item prepend-icon="mdi-account-multiple-plus" title="Manage Invitations"
                        @click="goToSession('manageInvitations')" v-if="currentUser.role=='owner'"></v-list-item>
                    <v-list-item prepend-icon="mdi-account-group" title="Manage Users"
                        @click="goToSession('manageUsers')" v-if="currentUser.role=='owner'"></v-list-item>
                </v-list>
                <template v-slot:append>
                    <v-divider></v-divider>
                    <div class="pa-2" v-if="currentUser">
                        <b>{{users[currentUser.email].name}}</b> <span>{{` (${currentUser.role})`}}</span>
                        <v-list-item prepend-icon="mdi-account" title="Edit Profile"
                            @click="goToSession('userInfo')"></v-list-item>
                    </div>
                    <div class="pa-2">
                        <v-btn prepend-icon="mdi-logout" color="yellow" @click="logout" v-if="currentUser" block>
                            <template v-slot:prepend>
                                <v-icon color="red"></v-icon>
                            </template>
                            Logout
                        </v-btn>
                        <v-btn prepend-icon="mdi-account-circle" color="yellow" @click="goToSession('login')"
                            v-if="!currentUser" block>
                            <template v-slot:prepend>
                                <v-icon color="success"></v-icon>
                            </template>
                            Login
                        </v-btn>
                    </div>
                </template>
            </v-navigation-drawer>
            <v-main style="height:100vh">
                <?!= include('html/login'); ?>
                <?!= include('html/table'); ?>
                <?!= include('html/management'); ?>
                <?!= include('html/signup'); ?>
                <?!= include('html/invitation'); ?>
                <?!= include('html/change_password'); ?>
                <?!= include('html/user_info'); ?>
            </v-main>
        </v-layout>
    </v-card>
    <v-snackbar v-model="snackbar.show" :color="snackbar.color" :timeout="snackbar.timeout"
        :vertical="snackbar.vertical" :right="snackbar.right" :bottom="snackbar.bottom" multi-line elevation="24">
        <strong>{{snackbar.text}}</strong>
        <template v-slot:actions>
            <v-btn color="white" variant="text" @click="snackbar.show = false">
                Close
            </v-btn>
        </template>
    </v-snackbar>
</v-app>

  <script type="module">
    const { createApp } = Vue;
    const { createVuetify } = Vuetify;

    const vuetify = createVuetify();

    createApp({
        template: "#app-template",
        mixins: [authMixin, computeMixin, approvalMixin, leadManagmentMixin],
        data: () => ({
            dialog: false,
            appIsLoading: false,
            dialogDelete: false,
            viewDialog: false,
            inlineEditDialog: false,
            schema: null,
            prefs: null,
            search: "",
            headers: [],
            rules: {
                required: (value) => !!value || "Required.",
            },
            dataTable: [],
            unfilteredDataTable: [],
            editedIndex: -1,
            editedItem: {},
            defaultItem: {},
            snackbar: {
                text: "",
                show: false,
                timeout: 2000,
                color: "success",
                multiline: true,
                vertical: true,
                right: true,
                bottom: true,
            },
        }),

        computed: {
            formTitle() {
                return this.editedIndex === -1 ? "New Record" : "Edit Record";
            },
        },

        watch: {
            dialog(val) {
                val || this.close();
            },
            dialogDelete(val) {
                val || this.closeDelete();
            },
            viewDialog(val) {
                val || this.closeDetail();
            },
            schema(val) {
                this.doPostProcessing();
            },
        },

        created() {
            this.fetchSchema();
            this.refresh();
        },

        methods: {
            fetchSchema() {
                google.script.run
                    .withSuccessHandler((res) => {
                        this.schema = res.schema;
                        this.prefs = res.appSettings;
                        const schema = res.schema;
                        this.headers = schema.map((item) => {
                            return {
                                title: item.label,
                                key: item.key,
                                sortable: item.sortable || true,
                                align: item.align || "start",
                                width: item.width || null,
                                type: item.type,
                            };
                        });
                        // this.headers.push({
                        //   text: "Actions",
                        //   key: "actions",
                        //   sortable: false,
                        // });
                        const idHeader = { title: 'ID', key: this.prefs.IdColumn }
                        this.headers = [idHeader, ...this.headers, {
                            text: "Actions",
                            key: "actions",
                            sortable: false,
                            width: '5%'
                        }];

                        console.log("Headers", this.headers);

                        this.editedItem = schema.reduce((acc, item) => {

                            if (item.type === "tags") {
                                acc[item.key] = null;
                            } else {
                                acc[item.key] = item.defaultValue || "";
                            }

                            return acc;
                        }, {});
                        this.defaultItem = schema.reduce((acc, item) => {
                            acc[item.key] = item.defaultValue || "";
                            return acc;
                        }, {});

                        this.schema.forEach((item) => {
                            if (item.required) {
                                item.label = `${item.label} *`;
                            }
                            if (item.type === "select_option_source" && typeof item.optionSource === 'string') {
                                item.optionSource = {
                                    source: item.optionSource.split('&')[0].split('=')[1],
                                    key: item.optionSource.split('&')[1].split('=')[1],
                                    label: item.optionSource.split('&')[2].split('=')[1]
                                };
                            }
                        });
                        this.schema.forEach((item) => {
                            if (item.type === "select_option_source" && item.optionSource) {
                                google.script.run
                                    .withSuccessHandler((res) => {
                                        item.options = JSON.parse(res);
                                        console.log("Options", item.options);
                                        this.filterDataOnRoleBasis();
                                    })
                                    .withFailureHandler((error) => {
                                        console.log(error);
                                    })
                                    .getSheetData(item.optionSource.source);
                            }
                        });
                    })
                    .withFailureHandler((error) => {
                        console.log(error);
                    })
                    .getAppPrefs();


            },
            refresh() {
                this.appIsLoading = true;
                google.script.run
                    .withSuccessHandler((res) => {
                        console.log("Schema", this.schema);
                        this.loadDataTable(res);
                        this.appIsLoading = false;
                    })
                    .withFailureHandler((error) => {
                        console.log(error);
                    })
                    .readAllRecords();
            },
            loadDataTable(res) {
                let data = JSON.parse(res);
                this.dataTable = data;

                console.log("Parsed Data", data);
                if (!this.schema) {
                    return;
                }
                const dateFlds = this.schema.filter(
                    (fld) => fld.type === "date"
                );
                data = data.map((item) => {
                    dateFlds.forEach((fld) => {
                        if (item[fld.key] != "") {
                            const dt = new Date(item[fld.key]);
                            item[fld.key] = `${dt.getFullYear()}-${(
                                "0" +
                                (dt.getMonth() + 1)
                            ).slice(-2)}-${("0" + dt.getDate()).slice(-2)}`;
                        }
                    });
                    return item;
                });
                this.unfilteredDataTable = JSON.parse(JSON.stringify(data));
                this.dataTable = data;
                this.filterDataOnRoleBasis();
            },
            doPostProcessing() {
                const dateFlds = this.schema.filter(
                    (fld) => fld.type === "date"
                );
                if (!this.dataTable) {
                    return;
                };
                this.dataTable = this.dataTable.map((item) => {
                    dateFlds.forEach((fld) => {
                        if (item[fld.key] != "") {
                            const dt = new Date(item[fld.key]);
                            item[fld.key] = `${dt.getFullYear()}-${(
                                "0" +
                                (dt.getMonth() + 1)
                            ).slice(-2)}-${("0" + dt.getDate()).slice(-2)}`;
                        }
                    });
                    return item;
                });
            },

            editItem(item) {
                this.editedIndex = this.dataTable.indexOf(item);
                this.editedItem = Object.assign({}, item);
                this.dialog = true;
                // Handle fld of type tags 
                this.schema.forEach((fld) => {
                    if (fld.type === "tags") {
                        this.editedItem[fld.key] = this.editedItem[fld.key].split(',');
                    }
                });


                // let userIDs = this.editedItem['Edited By'];
                // if (userIDs === '') {
                //     userIDs = this.users[this.currentUser.email].email;
                // } else {
                //     userIDs = userIDs + ',' + this.users[this.currentUser.email].email;
                // }
                // userIDs = userIDs.split(',').filter((item, i, allItems) => i === allItems.indexOf(item)).join(',');
                // this.editedItem['Edited By'] = userIDs;
            },
            constructEditHistory(editedItem) {

                const editHistory = editedItem['history'] == '' ? [] : JSON.parse(editedItem['history']);
                const oldItem = this.unfilteredDataTable[this.editedIndex];

                const currentDate = new Date().toLocaleDateString();
                const currentUser = this.users[this.currentUser.email].name;

                this.schema.forEach((fld) => {
                    if (this.editedItem[fld.key] != oldItem[fld.key]) {
                        console.log(`${fld.label} changed from ${oldItem[fld.key]} to ${this.editedItem[fld.key]} by ${currentUser} on ${currentDate}`);
                        editHistory.push(`${fld.label} changed from ${oldItem[fld.key]} to ${this.editedItem[fld.key]} by ${currentUser} on ${currentDate}`);
                    }
                });
                console.log(editHistory);
                this.editedItem['history'] = JSON.stringify(editHistory);

            },

            deleteItem(item) {
                this.editedIndex = this.dataTable.indexOf(item);
                this.editedItem = Object.assign({}, item);
                this.dialogDelete = true;
            },
            viewItem(item) {
                this.editedIndex = this.dataTable.indexOf(item);
                this.editedItem = Object.assign({}, item);
                this.viewDialog = true;
            },

            deleteItemConfirm() {
                this.appIsLoading = true;
                this.showSnackbar("Deleting ...", "warning", -1);
                this.closeDelete();
                google.script.run
                    .withSuccessHandler((res) => {
                        console.log(res);
                        this.dataTable.splice(this.editedIndex, 1);
                        this.loadDataTable(res);
                        this.showSnackbar("Record deleted successfully", "success");
                        this.appIsLoading = false;
                    })
                    .withFailureHandler((error) => {
                        console.log(error);
                    })
                    .deleteRecord(this.editedItem);
            },

            close() {
                this.dialog = false;
                this.$nextTick(() => {
                    this.editedItem = Object.assign({}, this.defaultItem);
                    this.editedIndex = -1;
                });
            },

            closeDetail() {
                this.viewDialog = false;
                this.$nextTick(() => {
                    this.editedItem = Object.assign({}, this.defaultItem);
                    this.editedIndex = -1;
                });
            },

            closeDelete() {
                this.dialogDelete = false;
                this.$nextTick(() => {
                    this.editedItem = Object.assign({}, this.defaultItem);
                    this.editedIndex = -1;
                });
            },

            save() {
                if (!this.validate()) {
                    return;
                }
                this.showSnackbar("Saving item...", "info");
                this.appIsLoading = true;
                // Handle fld of type tags 
                this.schema.forEach((fld) => {
                    if (fld.type === "tags") {
                        this.editedItem[fld.key] = this.editedItem[fld.key].join(',');
                    }
                });

                if (this.editedIndex > -1) {
                    console.log("Edited Item", this.editedItem);
                    this.constructEditHistory(this.editedItem);
                    google.script.run
                        .withSuccessHandler((res) => {
                            this.showSnackbar(
                                `Record saved successfully!`,
                                "success"
                            );
                            this.loadDataTable(res);
                            this.resetForm();

                        })
                        .withFailureHandler((error) => {
                            console.log(error);
                        })
                        .updateRecordById(this.editedItem);
                } else {
                    google.script.run
                        .withSuccessHandler((res) => {
                            this.showSnackbar(
                                `Record saved successfully!`,
                                "success"
                            );
                            this.loadDataTable(res);
                            this.resetForm();

                        })
                        .withFailureHandler((error) => {
                            console.log(error);
                        })
                        .createRecord(this.editedItem);
                }
                this.close();
            },
            resetForm() {
                this.editedItem = Object.assign({}, this.defaultItem);
                this.editedIndex = -1;
                this.appIsLoading = false;
            },
            validate() {
                let valid = true;
                let errorMsg = "";
                console.log("Validating", this.editedItem);
                this.schema.forEach((item) => {
                    if (item.required && this.editedItem[item.key] === "") {
                        console.log("Validation Error", item.key);
                        valid = false;
                        errorMsg = `Please fill in all mandatory fields marked with *. ${item.label} is required`;
                    }
                    if (item.key === "CONTACT NUMBER") {
                        console.log("Validation Error", item.key);

                        const phoneRegex = /^9\d{9}$/;
                        if (!phoneRegex.test(this.editedItem[item.key])) {
                            valid = false;
                            errorMsg = `Please enter a valid phone number`;
                        }
                    }
                });
                if (!valid) {
                    this.showSnackbar(errorMsg, "error");
                    return false;
                }
                return valid;
            },
            showSnackbar(text, color, timeout = 2000) {
                this.snackbar.text = text;
                this.snackbar.color = color;
                this.snackbar.show = true;
                this.snackbar.timeout = timeout;
            },
        },
    })
        .use(vuetify)
        .mount("#app");
</script>

  </body>
  
</html>
